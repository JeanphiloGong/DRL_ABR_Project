<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.dashjs.org/v3.2.2/dash.all.min.js"></script>
</head>
<body>
    <video id="videoPlayer" controls></video>
    <button id="playButton">ç‚¹å‡»æ’­æ”¾è§†é¢‘</button>
    <script>
        var url = "http://127.0.0.1:8080/dash_content/manifest.mpd";
        var player = dashjs.MediaPlayer().create();
        player.initialize(document.querySelector("#videoPlayer"), url, true);
        
        // **å…³é—­ DASH.js é»˜è®¤çš„ ABR è§„åˆ™**
        player.updateSettings({
            streaming: {
                abr: {
                    useDefaultABRRules: false
                }
            }
        });

        // å…¨å±€å˜é‡å­˜å‚¨ç çŽ‡åˆ‡æ¢æ¬¡æ•°
        if (typeof window.switchCount === 'undefined') {
            window.switchCount = 0;
            player.on(dashjs.MediaPlayer.events.QUALITY_CHANGE_RENDERED, function() {
                window.switchCount++;
            });
        }

        // è¯·æ±‚ DRLæœåŠ¡å™¨èŽ·å–æŽ¨èç çŽ‡
        async function getDrlBitrate() {
            try {
                let dashMetrics = player.getDashMetrics();
                let qualityIndex = player.getQualityFor("video");  // èŽ·å–å½“å‰æ’­æ”¾çš„è´¨é‡çº§åˆ«ï¼ˆç´¢å¼•ï¼‰
                let bitrateInfo = player.getBitrateInfoListFor("video");

                let currentBitrate = bitrateInfo && bitrateInfo[qualityIndex] ? bitrateInfo[qualityIndex].bitrate : 0;
                let bufferLevel = dashMetrics ? dashMetrics.getCurrentBufferLevel("video") || 0 : 0;
                let httpRequests = dashMetrics.getHttpRequests("video");
                let latestRequest = httpRequests.length ? httpRequests[httpRequests.length - 1] : null;
                let throughput = latestRequest && latestRequest._throughput ? latestRequest._throughput : 0;

                let latestRequest1 = dashMetrics.getHttpRequests("video").slice(-1)[0];
                let latency = latestRequest1 ? latestRequest1.latency : 0;
                let switchCount = window.switchCount;

                let data = {
                    timestamp: new Date().toISOString(),
                    bitrate: currentBitrate,  // ç çŽ‡ (bps)
                    buffer: bufferLevel,      // ç¼“å†²åŒºå¤§å° (ç§’)
                    throughput: throughput,   // ç½‘ç»œå¸¦å®½ä¼°è®¡ (bps)
                    latency: latency,         // ç½‘ç»œå»¶è¿Ÿ (ç§’)
                    switch_count: switchCount // ç çŽ‡åˆ‡æ¢æ¬¡æ•°
                };

                console.log("ðŸš€ å‘é€åˆ° DRL æœåŠ¡å™¨çš„æ•°æ®:", data);

                let response = await fetch('http://127.0.0.1:5000/predict_bitrate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                let result = await response.json();
                console.log("ðŸš€ DRL æœåŠ¡å™¨è¿”å›žçš„ç»“æžœ:", result.bitrate);

                return result.bitrate;
            } catch (error) {
                console.error("ðŸš¨ èŽ·å– DRL æŽ¨èç çŽ‡å¤±è´¥:", error);
                return null;
            }

        }

        // åŠ è½½æ–°çš„è§†é¢‘ç‰‡æ®µå‰è°ƒç”¨ DRL æ¨¡åž‹
        player.on(dashjs.MediaPlayer.events.FRAGMENT_LOADING_PROGRESS, async function () {
            let drlBitrate = await getDrlBitrate();
            if (drlBitrate) {
                let bitrateList = player.getBitrateInfoListFor("video");
                let qualityIndex = bitrateList.findIndex(b => b.bitrate === drlBitrate);

                if (qualityIndex !== -1) {
                    console.log(`ðŸŽ¯ è®¾ç½®ç çŽ‡: ${drlBitrate} (è´¨é‡ç´¢å¼•: ${qualityIndex})`);
                    player.setQualityFor("video", qualityIndex);
                } else {
                    console.warn("âš ï¸ DRL é€‰æ‹©çš„ç çŽ‡æœªæ‰¾åˆ°åŒ¹é…ç´¢å¼•ï¼Œè·³è¿‡è®¾ç½®");
                }
            }
        });

        // è®°å½•æ—¥å¿—çš„å‡½æ•°
        function logMetrics() {
            try {
                let dashMetrics = player.getDashMetrics();
                let qualityIndex = player.getQualityFor("video");  // èŽ·å–å½“å‰æ’­æ”¾çš„è´¨é‡çº§åˆ«ï¼ˆç´¢å¼•ï¼‰
                let bitrateInfo = player.getBitrateInfoListFor("video");

                let currentBitrate = bitrateInfo && bitrateInfo[qualityIndex] ? bitrateInfo[qualityIndex].bitrate : 0;
                let bufferLevel = dashMetrics ? dashMetrics.getCurrentBufferLevel("video") || 0 : 0;
                let httpRequests = dashMetrics.getHttpRequests("video");
                let latestRequest = httpRequests.length ? httpRequests[httpRequests.length - 1] : null;
                let throughput = latestRequest && latestRequest._throughput ? latestRequest._throughput : 0;

                let latestRequest1 = dashMetrics.getHttpRequests("video").slice(-1)[0];
                let latency = latestRequest1 ? latestRequest1.latency : 0;
                let switchCount = window.switchCount;

                let logEntry = {
                    timestamp: new Date().toISOString(),
                    bitrate: currentBitrate,  // ç çŽ‡ (bps)
                    buffer: bufferLevel,      // ç¼“å†²åŒºå¤§å° (ç§’)
                    throughput: throughput,   // ç½‘ç»œå¸¦å®½ä¼°è®¡ (bps)
                    latency: latency,         // ç½‘ç»œå»¶è¿Ÿ (ç§’)
                    switch_count: switchCount // ç çŽ‡åˆ‡æ¢æ¬¡æ•°
                };

                console.log("Log Entry:", logEntry);

                // å‘é€æ—¥å¿—åˆ° Flask æœåŠ¡å™¨
                fetch('http://127.0.0.1:5000/log', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(logEntry)
                })
                .then(response => response.json())
                .then(data => console.log('æ—¥å¿—å‘é€æˆåŠŸ:', data))
                .catch(error => console.error("æ—¥å¿—å‘é€å¤±è´¥:", error));

            } catch (error) {
                console.error("âš ï¸ logMetrics æ‰§è¡Œå‡ºé”™:", error);
            }
        }

        // æ¯ 1 ç§’è®°å½•ä¸€æ¬¡æ—¥å¿—
        setInterval(logMetrics, 1000);


        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨æ¥è·Ÿè¸ªç çŽ‡åˆ‡æ¢æ¬¡æ•°
        if (!window.switchCount) {
            window.switchCount = 0;
            player.on(dashjs.MediaPlayer.events.QUALITY_CHANGE_RENDERED, function() {
                window.switchCount++;
            });
        }


        // ç›‘å¬éŸ³è½¨åŠ è½½å¹¶åˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªéŸ³è½¨
        player.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, function () {
            let audioTracks = player.getTracksFor("audio");
            if (audioTracks.length > 0) {
                console.log("åˆ‡æ¢åˆ°éŸ³é¢‘è½¨é“ï¼š" + audioTracks[0].id);
                player.setCurrentTrack(audioTracks[0]);
            }
        });

        document.getElementById("playButton").addEventListener("click", function() {
            var video = document.querySelector("#videoPlayer");
            video.play().then(() => {
                console.log("è§†é¢‘æ’­æ”¾æˆåŠŸ");
            }).catch(error => {
                console.error("æ’­æ”¾å¤±è´¥:", error);
            });
        });

    </script>
</body>
</html>
